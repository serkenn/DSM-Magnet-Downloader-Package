#!/bin/sh
set -eu

TARGET_DIR="/var/packages/${SYNOPKG_PKGNAME}/target"
VAR_DIR="/var/packages/${SYNOPKG_PKGNAME}/var"
LOG_FILE="${VAR_DIR}/package.log"
RUN_MARKER="${VAR_DIR}/running"
PID_FILE="${VAR_DIR}/ui-http.pid"

mkdir -p "${VAR_DIR}"
exec >>"${LOG_FILE}" 2>&1

echo "[$(date '+%Y-%m-%d %H:%M:%S')] action=$1"

case "$1" in
  start)
    if [ ! -x "${TARGET_DIR}/start.sh" ]; then
      echo "start.sh is missing or not executable: ${TARGET_DIR}/start.sh"
      exit 1
    fi
    "${TARGET_DIR}/start.sh"
    touch "${RUN_MARKER}"
    ;;
  stop)
    if [ -x "${TARGET_DIR}/stop.sh" ]; then
      "${TARGET_DIR}/stop.sh"
    else
      echo "stop.sh is missing or not executable: ${TARGET_DIR}/stop.sh"
    fi
    rm -f "${RUN_MARKER}"
    ;;
  status)
    if [ -f "${PID_FILE}" ] && kill -0 "$(cat "${PID_FILE}")" 2>/dev/null; then
      exit 0
    fi
    if [ -f "${RUN_MARKER}" ]; then
      exit 0
    fi
    exit 1
    ;;
  prestart|prestop)
    ;;
esac

exit 0
